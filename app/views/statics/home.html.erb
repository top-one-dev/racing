<% flash.each do |key, value| %>	
	<% if key == 'notice' %>
		<div class="alert alert-success"><%= value %> </div>		
	<% else %>
		<div class="alert alert-<%= key %>"><%= value %> </div>		
	<% end %>
<% end %>

<% if session[:access_token].nil? %>
	<center>
		<h1>Hammerfest is flexible racing for busy athletes. Link your Strava account and join a hammerfest today!</h1>
		<%= link_to (image_tag "ConnectWithStrava2x.png"), '/auth' %>
	</center>
<% else %>
<% today = Time.now.to_date %>
	<div class="panel panel-custom">
	  <div class="panel-heading">Available races</div>
	  <div class="panel-body">
	  	<% if @available_races.nil? %>
	  		No races available to join
	  	<% else %>
	  		<table>	  			
	  			<% @available_races.each do |race| %>
	  			<tr>
	  				<td>
	  					<%= race.name unless race.rosters.find_by(cyclist_id: session[:cyclist_id]) %>
	  					<%= link_to race.name, race_result_path(race_id: race) if race.rosters.find_by(cyclist_id: session[:cyclist_id]) %>
	  					&nbsp;&nbsp;&nbsp;
	  				</td>
	  				<td><%= race.stages.first.active_date.to_formatted_s(:short) if race.stages.first %> - <%= race.stages.last.close_date.to_formatted_s(:short) if race.stages.last %>&nbsp;&nbsp;&nbsp;</td>
	  				<td><%= link_to 'Join this race', {:action=>"create", :controller=>"rosters", :roster => {race_id: race.id, cyclist_id: session[:cyclist_id]}}, remote: true, :class => 'ajax' unless race.stages.first.active_date <= today and race.rosters.find_by(cyclist_id: session[:cyclist_id]) %>
	  				<div class="loader"></div>	  				
	  				</td>
	  				<script type="text/javascript">
	  					$('.ajax').bind('ajax:beforeSend', function(){
	  						index = $(this).index()
	  						$('.loader').eq(index).show();
	  					});

	  					$('.ajax').bind('ajax:complete', function(){
	  						$('.loader').eq(index).hide();
	  					});
	  				</script>
	  			</tr>
	  			<% end %>	
	  		</table>
	  	<% end %>
	  </div>
	</div>
	<div class="panel panel-custom">
	  <div class="panel-heading">My result</div>
	  <div class="panel-body">
	  <% if @cyclist_result.nil? %>
	  	No results...
	  <% else %>
	  	<table>
	  		<tr>
  				<td>Race</td>
  				<td>Stage</td>
  				<td>Time</td>
  				<td>Starava URL</td>
  				<td>Avg Watts</td>
  				<td>W/kg</td>
  				<td>Time stamp</td>
  			</tr>
		<% @cyclist_result.each do |result| %>
			<tr>
				<td><%= @cyclist_result.race %></td>
				<td><%= @cyclist_result.stage %></td>
				<td><%= @cyclist_result.time %></td>
				<td><%= @cyclist_result.starva_url%></td>
				<td><%= @cyclist_result.avg_watts %></td>
				<td><%= @cyclist_result.watts_per_k %></td>
				<td><%= @cyclist_result.time_stamp %></td>
			</tr>
		<% end %>
		</table>
	  <% end %>
	  	
	  </div>
	</div>
<% end %>